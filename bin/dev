#!/bin/bash
set -eo pipefail

# MacOS
if [[ "$OSTYPE" =~ ^darwin ]]; then
    echo "detected MacOS"
    brew update
    brew bundle
    sudo ln -sfv $PWD/bash/shells /etc/shells
fi

# Linux
if [[ "$OSTYPE" =~ ^linux ]]; then
    echo "detected Linux"
    sudo apt update
    sudo apt install -y software-properties-common
    sudo add-apt-repository -y ppa:neovim-ppa/stable
    sudo apt update
    sudo apt install -y \
        bash \
        git \
        tmux \
        neovim \
        gcc \
        bat \
        httpie \
        fzf \
        jq

    cargo install \
        lsd

    pip install \
        ydiff
fi

echo
echo "linking config files"
# VSCode
if [[ "$OSTYPE" =~ ^darwin ]]; then
    ln -fsv $PWD/vscode/settings.json $HOME/Library/Application\ Support/Code/User/settings.json
fi
if [[ "$OSTYPE" =~ ^linux ]]; then
    ln -fsv $PWD/vscode/settings.json $HOME/.config/Code/User/settings.json
fi
# Bash
ln -sfv \
    $PWD/bash/.bashrc \
    $PWD/bash/.bash_profile \
    $PWD/bash/.bash_aliases \
    $PWD/bash/.bash_prompt \
    ~
# Git
ln -fsv $PWD/git/.gitconfig ~
# TMUX
ln -fsv $PWD/tmux/.tmux.conf ~/.tmux.conf
# Install Tmux Plugin Manager
if [ -e ~/.tmux/plugins/tpm ]; then
    git -C ~/.tmux/plugins/tpm pull
else
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

# SSH
mkdir -p ~/.ssh
ln -fsv $PWD/ssh/config ~/.ssh
mkdir -p ~/.ssh/config.d
ln -fsv $PWD/ssh/config.d/* ~/.ssh/config.d


echo
echo "setting up neovim"
mkdir -p ~/.config/nvim && ln -fsv $PWD/etc/init.vim ~/.config/nvim/init.vim
curl -fLo ~/.config/nvim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

echo
echo "disabling login message"
touch ~/.hushlogin
