#!/bin/bash
set -eo pipefail

[[ -z $1 ]] && echo "No key provided" && exit 1
KEY=$1
[[ -z $2 ]] && echo "No file provided" && exit 1
FILE=$2

VAULT_FILE=vault/$FILE
mkdir -pv `dirname $VAULT_FILE`

ARCHIVE_FILE=tmp/$FILE.tar
mkdir -pv `dirname $ARCHIVE_FILE`
tar -cvf $ARCHIVE_FILE $FILE
echo "archived '$FILE' -> '$ARCHIVE_FILE'"

openssl/bin/encrypt-file $KEY $ARCHIVE_FILE > $VAULT_FILE
echo "encrypted '$ARCHIVE_FILE' -> '$VAULT_FILE'"

rm -v $ARCHIVE_FILE
